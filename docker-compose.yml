version: "3.9"
services:
  chat_db:
    image: postgres:15.3-alpine
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: 123123123
      POSTGRES_DB: chat_db
    ports:
      - "15432:5432"

  redis-db:
    image: redis:7.0.5-alpine
    ports:
      - "16379:6379"

  broker:
    image: bitnami/nats:2.9.15
    command: nats-server -js
    ports:
      - "4222:4222"
      - "6222:6222"
      - "8222:8222"

  consul:
    image: consul:1.15
    ports:
      - 8500:8500

  jaeger:
    image: jaegertracing/all-in-one:latest
    ports:
      - "16686:16686"
      - "14268:14268"
    environment:
      - COLLECTOR_OTLP_ENABLED=true
      - LOG_LEVEL=debug

  channel_service:
    build:
      dockerfile: ./services/channel_service/Dockerfile.dev
    environment:
      DB_DSN: ${DB_DSN}
      CONSUL_HOST: consul:8500
      JAEGER_HOST: http://jaeger:14268/api/traces
      REDIS_URI: redis://redis-db:6379

  chat_scheduler:
    build:
      dockerfile: services/chat_service/cmd/chat_scheduler/Dockerfile.dev
    environment:
      DB_DSN: postgresql://postgres:123123123@chat_db/chat_db?sslmode=disable
      CONSUL_HOST: consul:8500
      JAEGER_HOST: http://jaeger:14268/api/traces
      REDIS_URI: redis://redis-db:6379
      NATS_PUB_URI: ${NATS_URI}

  chat_sync_thread_consumer:
    build:
      dockerfile: services/chat_service/cmd/chat_sync_thread_consumer/Dockerfile.dev
    environment:
      DB_DSN: postgresql://postgres:123123123@chat_db/chat_db?sslmode=disable
      CONSUL_HOST: consul:8500
      JAEGER_HOST: http://jaeger:14268/api/traces
      REDIS_URI: redis://redis-db:6379
      NATS_SUB_URI: ${NATS_URI}
      HERMES_ENDPOINT: https://dev-hermes-server.onpoint.vn
      HERMES_CLIENT_ID: ${HERMES_CLIENT_ID}
      HERMES_CLIENT_SECRET: ${HERMES_CLIENT_SECRET}

  chat_migrate:
    build:
      dockerfile: services/chat_service/cmd/chat_migrate/Dockerfile.dev
    environment:
      DB_DSN: postgresql://postgres:123123123@chat_db/chat_db?sslmode=disable
